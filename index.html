<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toro Chat Premium</title>
    
    <!-- Enhanced Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    
    <!-- Media Handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Core Styles */
        :root {
            --toro-red: #FF4B2B;
            --toro-dark-red: #FF416C;
            --toro-gold: #FDB347;
            --toro-black: #1A1A1A;
        }

        body {
            font-family: 'Poppins', sans-serif;
        }

        /* Advanced Animations */
        .toro-gradient {
            background: linear-gradient(135deg, var(--toro-red) 0%, var(--toro-dark-red) 100%);
        }

        .bull-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L60 30L30 60L0 30L30 0z' fill='%23FF4B2B' fill-opacity='0.05'/%3E%3C/svg%3E");
            background-size: 30px 30px;
        }

        /* Message Animations */
        @keyframes messageIn {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-bubble {
            animation: messageIn 0.3s ease forwards;
            transition: all 0.3s ease;
        }

        .message-bubble:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Loading Animation */
        .bull-loader {
            width: 40px;
            height: 40px;
            border: 4px solid var(--toro-red);
            border-left-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Button Effects */
        .toro-button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .toro-button::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: -100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transition: 0.5s;
        }

        .toro-button:hover::after {
            left: 100%;
        }

        /* Typing Indicator */
        .typing-indicator {
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--toro-red);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
            opacity: 0.6;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--toro-red);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--toro-dark-red);
        }

        /* Emoji Picker */
        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            padding: 12px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .emoji-button {
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .emoji-button:hover {
            background: rgba(255, 75, 43, 0.1);
            transform: scale(1.1);
        }

        /* Theme Transitions */
        .theme-transition {
            transition: all 0.3s ease;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            animation: toastIn 0.3s ease forwards;
        }

        @keyframes toastIn {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Voice Message Player */
        .voice-player {
            background: rgba(255, 75, 43, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .voice-player-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--toro-red);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .voice-player-button:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <!-- Core app script will follow -->
</body>
</html>
<script type="text/babel">
// Constants and Configurations
const GITHUB_USERNAME = 'YOUR_GITHUB_USERNAME';
const REPO_NAME = 'toro-chat';
const GITHUB_TOKEN = 'YOUR_GITHUB_TOKEN';

const THEMES = {
    RED: {
        primary: '#FF4B2B',
        secondary: '#FF416C',
        text: '#FFFFFF',
        background: '#F8F9FA'
    },
    DARK: {
        primary: '#1A1A1A',
        secondary: '#2D2D2D',
        text: '#FFFFFF',
        background: '#121212'
    },
    GOLD: {
        primary: '#FDB347',
        secondary: '#F4A236',
        text: '#1A1A1A',
        background: '#FFF9F0'
    }
};

const MESSAGE_TYPES = {
    TEXT: 'text',
    IMAGE: 'image',
    VOICE: 'voice',
    FILE: 'file',
    EMOJI: 'emoji'
};

const BULL_EMOJIS = ["🐂", "💪", "🔥", "⚡", "🌟", "✨", "🎯", "🎪", "🎭", "🎨", "🎪", "🎯"];

// Main App Component
function App() {
    // State Management
    const [view, setView] = useState('login'); // login, register, chat
    const [currentUser, setCurrentUser] = useState(null);
    const [theme, setTheme] = useState(THEMES.RED);
    const [friends, setFriends] = useState([]);
    const [chats, setChats] = useState([]);
    const [activeChat, setActiveChat] = useState(null);
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');
    const [showEmojiPicker, setShowEmojiPicker] = useState(false);
    const [notification, setNotification] = useState(null);
    const [isRecording, setIsRecording] = useState(false);
    const [unreadMessages, setUnreadMessages] = useState({});
    const [userStatus, setUserStatus] = useState('online');
    const [typing, setTyping] = useState(false);

    // Refs
    const fileInputRef = useRef(null);
    const chatEndRef = useRef(null);
    const mediaRecorder = useRef(null);
    const audioChunks = useRef([]);
    const typingTimeout = useRef(null);

    // Effects
    useEffect(() => {
        checkAuth();
        initializeAudioRecording();
        return () => cleanup();
    }, []);

    useEffect(() => {
        if (currentUser) {
            const interval = setInterval(refreshData, 3000);
            return () => clearInterval(interval);
        }
    }, [currentUser]);

    useEffect(() => {
        scrollToBottom();
    }, [messages]);

    // Authentication Functions
    const checkAuth = async () => {
        const userId = Cookies.get('toroUserId');
        if (userId) {
            try {
                const users = await fetchUsers();
                const user = users.find(u => u.id === userId);
                if (user) {
                    setCurrentUser(user);
                    setView('chat');
                    await loadUserData(user);
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }
        }
    };

    const handleLogin = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        try {
            const users = await fetchUsers();
            const user = users.find(u => 
                u.username === username && u.password === password
            );

            if (user) {
                Cookies.set('toroUserId', user.id, { expires: 30 });
                setCurrentUser(user);
                setView('chat');
                await loadUserData(user);
                showNotification('Welcome back to Toro Chat! 🐂');
            } else {
                setError('Invalid credentials');
                gsap.to('.login-form', {
                    x: [-10, 10, -10, 10, 0],
                    duration: 0.5
                });
            }
        } catch (error) {
            setError('Login failed. Please try again.');
        } finally {
            setIsLoading(false);
        }
    };

    // Message Handling
    const sendMessage = async (content, type = MESSAGE_TYPES.TEXT) => {
        if (!content || !activeChat) return;

        const message = {
            id: Date.now().toString(),
            sender: currentUser.id,
            type,
            content,
            timestamp: new Date().toISOString(),
            status: 'sent'
        };

        try {
            const chatsData = await fetchChats();
            const updatedChats = chatsData.map(chat => {
                if (chat.id === activeChat.id) {
                    return {
                        ...chat,
                        messages: [...chat.messages, message],
                        lastUpdate: Date.now()
                    };
                }
                return chat;
            });

            await updateGithubFile('chats.json', updatedChats);
            setMessages(prev => [...prev, message]);
            setNewMessage('');
            scrollToBottom();
        } catch (error) {
            showNotification('Failed to send message', 'error');
        }
    };

    // File Handling
    const handleFileUpload = async (file) => {
        if (file.size > 5 * 1024 * 1024) {
            showNotification('File must be smaller than 5MB', 'error');
            return;
        }

        setIsLoading(true);
        try {
            const base64 = await convertToBase64(file);
            await sendMessage(base64, 
                file.type.startsWith('image/') ? MESSAGE_TYPES.IMAGE : MESSAGE_TYPES.FILE
            );
        } catch (error) {
            showNotification('File upload failed', 'error');
        } finally {
            setIsLoading(false);
        }
    };

    // Voice Messages
    const initializeAudioRecording = () => {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder.current = new MediaRecorder(stream);
                    
                    mediaRecorder.current.ondataavailable = (e) => {
                        audioChunks.current.push(e.data);
                    };

                    mediaRecorder.current.onstop = async () => {
                        const audioBlob = new Blob(audioChunks.current, { type: 'audio/wav' });
                        const base64 = await convertToBase64(audioBlob);
                        await sendMessage(base64, MESSAGE_TYPES.VOICE);
                        audioChunks.current = [];
                    };
                })
                .catch(error => console.error('Microphone access denied:', error));
        }
    };

    // Utility Functions
    const convertToBase64 = (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    };

    const showNotification = (message, type = 'success') => {
        setNotification({ message, type });
        setTimeout(() => setNotification(null), 3000);
    };

    const scrollToBottom = () => {
        chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    };

    // Render Functions
    const renderLogin = () => (
        <div className="min-h-screen bull-pattern flex items-center justify-center p-4">
            <div className="max-w-md w-full bg-white rounded-2xl shadow-2xl p-8 login-form">
                <div className="text-center mb-8">
                    <div className="text-6xl mb-4">🐂</div>
                    <h1 className="text-4xl font-bold text-red-600 mb-2">
                        TORO CHAT
                    </h1>
                    <div className="text-gray-500">
                        Unleash the Power of Communication
                    </div>
                </div>
                {/* Login form components */}
            </div>
        </div>
    );

    // ... More render functions and component logic will follow ...
</script>
<script type="text/babel">
    // ... (continuing from previous code)

    // Chat Components
    const ChatInterface = () => (
        <div className="h-screen flex bg-gray-50">
            {/* Sidebar */}
            <div className="w-80 bg-white shadow-lg flex flex-col">
                {/* Profile Header */}
                <div className="p-6 toro-gradient">
                    <div className="flex items-center space-x-4">
                        <div className="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">
                            <span className="text-2xl animate-bounce">🐂</span>
                        </div>
                        <div>
                            <h2 className="text-white font-bold">@{currentUser?.username}</h2>
                            <div className="flex items-center text-red-100 text-sm">
                                <span className={`w-2 h-2 rounded-full ${
                                    userStatus === 'online' ? 'bg-green-400' : 'bg-gray-400'
                                } mr-2`}></span>
                                {userStatus}
                            </div>
                        </div>
                        <div className="ml-auto">
                            <button 
                                onClick={() => setShowSettings(true)}
                                className="text-white hover:bg-white/20 p-2 rounded-full transition-colors"
                            >
                                ⚙️
                            </button>
                        </div>
                    </div>
                </div>

                {/* Friends List */}
                <div className="flex-1 overflow-y-auto">
                    <div className="p-4">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-gray-500 font-semibold">Friends</h3>
                            <button 
                                onClick={() => setShowAddFriend(true)}
                                className="text-red-500 hover:bg-red-50 p-2 rounded-full transition-colors"
                            >
                                ➕
                            </button>
                        </div>
                        {friends.map(friend => (
                            <FriendListItem 
                                key={friend.id}
                                friend={friend}
                                unreadCount={unreadMessages[friend.id] || 0}
                                isActive={activeChat?.participants.includes(friend.id)}
                                onClick={() => startChat(friend.id)}
                            />
                        ))}
                    </div>
                </div>

                {/* Theme Selector */}
                <div className="p-4 border-t">
                    <div className="flex justify-around">
                        {Object.entries(THEMES).map(([name, theme]) => (
                            <button
                                key={name}
                                onClick={() => setTheme(theme)}
                                className={`w-8 h-8 rounded-full transition-transform hover:scale-110 ${
                                    currentTheme === theme ? 'ring-2 ring-offset-2 ring-red-500' : ''
                                }`}
                                style={{ background: theme.primary }}
                            />
                        ))}
                    </div>
                </div>
            </div>

            {/* Main Chat Area */}
            <div className="flex-1 flex flex-col">
                {activeChat ? (
                    <>
                        {/* Chat Header */}
                        <div className="bg-white shadow-sm p-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-4">
                                    <div className="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                                        <span className="text-xl">🐂</span>
                                    </div>
                                    <div>
                                        <h2 className="font-bold">
                                            {friends.find(f => 
                                                activeChat.participants.includes(f.id)
                                            )?.username}
                                        </h2>
                                        {typing && (
                                            <div className="text-sm text-gray-500 flex items-center">
                                                typing
                                                <div className="typing-indicator ml-2">
                                                    <div className="typing-dot"></div>
                                                    <div className="typing-dot"></div>
                                                    <div className="typing-dot"></div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Messages Area */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {messages.map((message, index) => (
                                <MessageBubble
                                    key={message.id}
                                    message={message}
                                    isOwn={message.sender === currentUser.id}
                                    showDate={shouldShowDate(message, messages[index - 1])}
                                />
                            ))}
                            <div ref={chatEndRef} />
                        </div>

                        {/* Input Area */}
                        <div className="p-4 bg-white shadow-lg">
                            <form onSubmit={handleSendMessage} className="space-y-4">
                                <div className="flex items-center space-x-2">
                                    {/* File Upload Button */}
                                    <button
                                        type="button"
                                        onClick={() => fileInputRef.current.click()}
                                        className="p-3 rounded-full hover:bg-gray-100 transition-colors"
                                        title="Send file"
                                    >
                                        📎
                                    </button>
                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        onChange={handleFileSelect}
                                        className="hidden"
                                        accept="image/*,.pdf,.doc,.docx"
                                    />

                                    {/* Message Input */}
                                    <input
                                        type="text"
                                        value={newMessage}
                                        onChange={(e) => {
                                            setNewMessage(e.target.value);
                                            handleTyping();
                                        }}
                                        placeholder="Type your message..."
                                        className="flex-1 p-3 rounded-full border focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                    />

                                    {/* Emoji Picker */}
                                    <button
                                        type="button"
                                        onClick={() => setShowEmojiPicker(!showEmojiPicker)}
                                        className="p-3 rounded-full hover:bg-gray-100 transition-colors"
                                        title="Add emoji"
                                    >
                                        😊
                                    </button>

                                    {/* Voice Message Button */}
                                    <button
                                        type="button"
                                        onMouseDown={startRecording}
                                        onMouseUp={stopRecording}
                                        onMouseLeave={stopRecording}
                                        className={`p-3 rounded-full transition-colors ${
                                            isRecording ? 'bg-red-500 text-white' : 'hover:bg-gray-100'
                                        }`}
                                        title="Record voice message"
                                    >
                                        🎤
                                    </button>

                                    {/* Send Button */}
                                    <button
                                        type="submit"
                                        className="toro-button bg-red-500 text-white px-6 py-3 rounded-full font-medium hover:bg-red-600 flex items-center space-x-2"
                                        disabled={!newMessage.trim() && !isRecording}
                                    >
                                        <span>Send</span>
                                        <span className="text-xl">⚡</span>
                                    </button>
                                </div>

                                {/* Emoji Picker Dropdown */}
                                {showEmojiPicker && (
                                    <div className="absolute bottom-20 right-4 bg-white rounded-lg shadow-lg">
                                        <div className="emoji-picker">
                                            {BULL_EMOJIS.map(emoji => (
                                                <button
                                                    key={emoji}
                                                    onClick={() => {
                                                        setNewMessage(prev => prev + emoji);
                                                        setShowEmojiPicker(false);
                                                    }}
                                                    className="emoji-button"
                                                >
                                                    {emoji}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </form>
                        </div>
                    </>
                ) : (
                    <div className="flex-1 flex flex-col items-center justify-center text-gray-500">
                        <div className="text-6xl mb-4">🐂</div>
                        <p className="text-xl font-medium">Select a friend to start chatting</p>
                        <p className="text-sm mt-2">Your messages are waiting!</p>
                    </div>
                )}
            </div>

            {/* Notifications */}
            {notification && (
                <div className="toast">
                    <div className={`p-4 rounded-lg ${
                        notification.type === 'error' ? 'bg-red-500' : 'bg-green-500'
                    } text-white`}>
                        {notification.message}
                    </div>
                </div>
            )}
        </div>
    );

    // Message Bubble Component
    const MessageBubble = ({ message, isOwn, showDate }) => {
        const renderContent = () => {
            switch (message.type) {
                case MESSAGE_TYPES.IMAGE:
                    return (
                        <a href={message.content} data-lightbox={message.id}>
                            <img 
                                src={message.content} 
                                alt="Shared image" 
                                className="max-w-xs rounded-lg cursor-pointer hover:opacity-90 transition-opacity"
                            />
                        </a>
                    );
                case MESSAGE_TYPES.VOICE:
                    return (
                        <div className="voice-player">
                            <audio controls src={message.content} className="max-w-xs" />
                        </div>
                    );
                case MESSAGE_TYPES.FILE:
                    return (
                        <a 
                            href={message.content}
                            download
                            className="flex items-center space-x-2 p-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
                        >
                            <span>📄</span>
                            <span>Download File</span>
                        </a>
                    );
                default:
                    return <p className="break-words">{message.content}</p>;
            }
        };

        return (
            <>
                {showDate && (
                    <div className="text-center text-sm text-gray-500 my-4">
                        {new Date(message.timestamp).toLocaleDateString()}
                    </div>
                )}
                <div className={`flex ${isOwn ? 'justify-end' : 'justify-start'}`}>
                    <div
                        className={`message-bubble max-w-[70%] p-3 rounded-lg ${
                            isOwn 
                                ? 'bg-red-500 text-white ml-auto' 
                                : 'bg-white shadow-md'
                        }`}
                    >
                        <p className="text-sm font-semibold mb-1">
                            {isOwn ? 'You' : message.sender}
                        </p>
                        {renderContent()}
                        <p className="text-xs opacity-75 mt-1">
                            {new Date(message.timestamp).toLocaleTimeString()}
                            {isOwn && (
                                <span className="ml-2">
                                    {message.status === 'sent' ? '✓' : '✓✓'}
                                </span>
                            )}
                        </p>
                    </div>
                </div>
            </>
        );
    };

    // Friend List Item Component
    const FriendListItem = ({ friend, unreadCount, isActive, onClick }) => (
        <button
            onClick={onClick}
            className={`w-full p-3 rounded-lg mb-2 flex items-center space-x-3 transition-all ${
                isActive 
                    ? 'bg-red-50 border-red-200'
                    : 'hover:bg-gray-50'
            }`}
        >
            <div className="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                <span className="text-xl">🐂</span>
            </div>
            <div className="flex-1 text-left">
                <p className="font-medium">@{friend.username}</p>
                <p className="text-xs text-gray-500">
                    {friend.status || 'Available'}
                </p>
            </div>
            {unreadCount > 0 && (
                <div className="bg-red-500 text-white text-xs px-2 py-1 rounded-full">
                    {unreadCount}
                </div>
            )}
        </button>
    );

    return (
        <div className="theme-transition" style={{ 
            backgroundColor: theme.background,
            color: theme.text
        }}>
            {view === 'login' && renderLogin()}
            {view === 'register' && renderRegister()}
            {view === 'chat' && <ChatInterface />}
        </div>
    );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
